name: Common .NET setup and build workflow

permissions:
  contents: read
  actions: write   # needed for the optional cleanup step at the end

on:
  workflow_call:
    inputs:
      configuration:
        type: string
        default: 'Release'
        description: 'Build configuration'

      dotnetVersions:
        type: string
        default: |
          8.0.x
          9.0.x
          10.0.x
        description: 'Newline-separated list of .NET SDKs'

      productNamespacePrefix:
        type: string
        required: true
        description: 'Namespace prefix for coverage include/exclude filters'

      useVisualStudioPreview:
        type: boolean
        default: false
        description: 'Use VS preview on Windows (for UNO/mobile scenarios)'

      solutionFile:
        type: string
        description: 'Solution file relative to srcFolder'

      srcFolder:
        type: string
        default: 'src'
        description: 'Folder containing the solution'

      performTests:
        type: boolean
        default: true
        description: 'Run tests + collect coverage on each OS'

      useNBGV:
        type: boolean
        default: true
        description: 'Run NBGV to stamp version variables'

      createArtifacts:
        type: boolean
        default: true
        description: 'Upload NuGet packages from Windows job'

      installWorkloads:
        type: boolean
        default: false
        description: 'If true, run workload restore (all OSes)'

      useUNO:
        type: boolean
        default: false
        description: 'Enable UNO-specific steps on Windows (msbuild/pack flow)'

      testsProjectGlob:
        type: string
        default: '**/*Tests*.csproj'
        description: 'Glob for test csproj files, relative to srcFolder'

      coverageFormats:
        type: string
        default: 'cobertura'
        description: 'Coverage output format (cobertura, xml, coverage)'

      testingMode:
        type: string
        default: 'auto'
        description: 'Testing mode: auto (detect), mtp (Microsoft Testing Platform), legacy (Coverlet)'

      mergedCoverageArtifactName:
        type: string
        default: 'coverage-all'
        description: 'Name of the artifact with all raw coverage reports'

      cleanupPerOsArtifacts:
        type: boolean
        default: true
        description: 'Delete the temporary per-OS artifacts after final upload'

      uploadCodecov:
        type: boolean
        default: true
        description: 'Upload coverage to Codecov in the collector job'

      enableDetailedTestLogging:
        type: boolean
        default: false
        description: 'Enable detailed verbosity for MTP test runs (useful for debugging hangs)'

    secrets:
      NuGetAPIKey:
        required: false
        description: 'API key for pushing packages to nuget.org'
      CODECOV_TOKEN:
        required: false
        description: 'Token for uploading coverage reports to Codecov'

jobs:
  # ============================
  # WINDOWS (parallel)
  # ============================
  build-windows:
    runs-on: windows-latest
    env:
      DOTNET_CLI_WORKLOAD_UPDATE_NOTIFY_DISABLE: 1
    outputs:
      nbgv: ${{ steps.environment.outputs.nbgv-semver2 }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          lfs: true

      - name: Setup .NET Environment
        id: environment
        uses: reactiveui/actions-common/.github/actions/dotnet-environment@main
        with:
          dotnet-versions: ${{ inputs.dotnetVersions }}
          src-folder: ${{ inputs.srcFolder }}
          solution-file: ${{ inputs.solutionFile }}
          install-workloads: ${{ inputs.installWorkloads }}
          use-nbgv: ${{ inputs.useNBGV }}

      - name: Build (dotnet)
        if: inputs.useUNO == false
        uses: reactiveui/actions-common/.github/actions/dotnet-build@main
        with:
          configuration: ${{ inputs.configuration }}
          src-folder: ${{ inputs.srcFolder }}
          solution-file: ${{ inputs.solutionFile }}
          create-packages: 'true'

      - name: Build (UNO)
        if: inputs.useUNO == true
        uses: reactiveui/actions-common/.github/actions/dotnet-build-uno@main
        with:
          configuration: ${{ inputs.configuration }}
          src-folder: ${{ inputs.srcFolder }}
          solution-file: ${{ inputs.solutionFile }}

      - name: Test
        if: inputs.performTests == true
        uses: reactiveui/actions-common/.github/actions/dotnet-test@main
        with:
          configuration: ${{ inputs.configuration }}
          src-folder: ${{ inputs.srcFolder }}
          solution-file: ${{ inputs.solutionFile }}
          testing-mode: ${{ inputs.testingMode }}
          tests-project-glob: ${{ inputs.testsProjectGlob }}
          coverage-formats: ${{ inputs.coverageFormats }}
          product-namespace-prefix: ${{ inputs.productNamespacePrefix }}
          enable-detailed-test-logging: ${{ inputs.enableDetailedTestLogging }}

      - name: Upload NuGet Packages
        if: inputs.createArtifacts == true
        uses: actions/upload-artifact@v7
        with:
          name: nuget
          path: '**/*.nupkg'
          if-no-files-found: warn

  # ============================
  # LINUX & MACOS (parallel matrix)
  # ============================
  build-unix:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest]
    env:
      DOTNET_CLI_WORKLOAD_UPDATE_NOTIFY_DISABLE: 1
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Setup .NET Environment
        id: environment
        uses: reactiveui/actions-common/.github/actions/dotnet-environment@main
        with:
          dotnet-versions: ${{ inputs.dotnetVersions }}
          src-folder: ${{ inputs.srcFolder }}
          solution-file: ${{ inputs.solutionFile }}
          install-workloads: ${{ inputs.installWorkloads }}
          use-nbgv: ${{ inputs.useNBGV }}

      - name: Build
        uses: reactiveui/actions-common/.github/actions/dotnet-build@main
        with:
          configuration: ${{ inputs.configuration }}
          src-folder: ${{ inputs.srcFolder }}
          solution-file: ${{ inputs.solutionFile }}
          create-packages: 'false'

      - name: Test
        if: inputs.performTests == true
        uses: reactiveui/actions-common/.github/actions/dotnet-test@main
        with:
          configuration: ${{ inputs.configuration }}
          src-folder: ${{ inputs.srcFolder }}
          solution-file: ${{ inputs.solutionFile }}
          testing-mode: ${{ inputs.testingMode }}
          tests-project-glob: ${{ inputs.testsProjectGlob }}
          coverage-formats: ${{ inputs.coverageFormats }}
          product-namespace-prefix: ${{ inputs.productNamespacePrefix }}
          enable-detailed-test-logging: ${{ inputs.enableDetailedTestLogging }}

  # ============================
  # COLLECTOR (waits for all) â€” uploads once + Codecov
  # ============================
  collect-coverage:
    needs:
      - build-windows
      - build-unix
    if: inputs.performTests == true
    runs-on: ubuntu-latest
    steps:
      - name: Checkout (for PR summary context)
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Download temp coverage artifacts
        uses: actions/download-artifact@v8
        with:
          pattern: tmp-coverage-*
          path: ./.collect

      - name: Upload raw coverage reports (for debugging)
        uses: actions/upload-artifact@v7
        with:
          name: ${{ inputs.mergedCoverageArtifactName }}
          path: ./.collect
          if-no-files-found: warn
          retention-days: 30

      - name: Install and Upload to Codecov
        if: inputs.uploadCodecov == true && (github.event_name != 'pull_request' || github.event.pull_request.head.repo.fork == false)
        env:
          CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}
        run: |
          pip install codecov-cli
          # Collect all cobertura files and upload in a single command
          FILES=$(find ./.collect -name '*.cobertura.xml' -type f | sed 's/^/--file /' | tr '\n' ' ')
          codecov-cli upload-coverage $FILES

      - name: Cleanup per-OS temp artifacts
        continue-on-error: true
        if: inputs.cleanupPerOsArtifacts == true
        env:
          GH_TOKEN: ${{ github.token }}
          REPO: ${{ github.repository }}
        shell: bash
        run: |
          for name in tmp-coverage-windows tmp-coverage-Linux tmp-coverage-macOS; do
            id=$(gh api repos/$REPO/actions/artifacts --paginate --jq ".artifacts[] | select(.name==\"$name\") | .id" | head -n1)
            if [ -n "$id" ]; then
              gh api -X DELETE repos/$REPO/actions/artifacts/$id
              echo "Deleted $name (id $id)"
            else
              echo "No artifact named $name found to delete."
            fi
          done
